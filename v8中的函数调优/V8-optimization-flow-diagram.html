<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>V8 优化与 Bailout 流程图</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#7dd3fc;--muted:#9ca3af;--glass:rgba(255,255,255,0.04)}
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial}
    body{background:linear-gradient(180deg,#071024 0%, #081226 60%);color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:28px}
    .canvas{width:900px;max-width:96vw;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:14px;padding:22px;box-shadow:0 8px 30px rgba(2,6,23,0.7);}
    h1{font-size:18px;margin:0 0 12px 0;color:var(--accent)}
    p.desc{margin:0 0 18px 0;color:var(--muted);font-size:13px}
    .svg-wrap{background:var(--card);border-radius:12px;padding:18px;border:1px solid var(--glass)}
    svg{width:100%;height:420px;display:block}
    .note{font-size:12px;color:var(--muted);margin-top:12px}
    .legend{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    .chip{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted);border:1px solid rgba(255,255,255,0.02)}
  </style>
</head>
<body>
  <div class="canvas">
    <h1>V8 优化 → Bailout → Deopt 流程图</h1>
    <p class="desc">示意 Ignition（解释器），TurboFan（优化编译器），以及当假设失效时的 Bailout / Deoptimization 回退流程与常见触发原因。</p>

    <div class="svg-wrap">
      <svg viewBox="0 0 1000 480" xmlns="http://www.w3.org/2000/svg" aria-label="V8 optimization flow">
        <defs>
          <linearGradient id="g1" x1="0" x2="1">
            <stop offset="0" stop-color="#0ea5e9" stop-opacity="0.12"/>
            <stop offset="1" stop-color="#7dd3fc" stop-opacity="0.06"/>
          </linearGradient>
          <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="8" stdDeviation="18" flood-opacity="0.25" flood-color="#000"/>
          </filter>
        </defs>

        <!-- Ignition box -->
        <g class="node">
          <rect x="48" y="48" width="240" height="120" rx="12" fill="#051426" stroke="#134e7a" stroke-width="1.2" filter="url(#shadow)"/>
          <text x="168" y="84" fill="#9ce8ff" font-size="18" font-weight="600" text-anchor="middle">Ignition</text>
          <text x="168" y="106" fill="#cfeeff" font-size="13" text-anchor="middle">解释器（bytecode）</text>
          <text x="168" y="128" fill="#9ca3af" font-size="12" text-anchor="middle">收集类型反馈 · 执行热度统计</text>
        </g>

        <!-- arrow to optimizer -->
        <g>
          <defs>
            <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
              <path d="M 0 0 L 10 5 L 0 10 z" fill="#7dd3fc"/>
            </marker>
          </defs>
          <path d="M 288 108 L 420 108" stroke="#7dd3fc" stroke-width="2" fill="none" marker-end="url(#arrow)"/>
          <text x="354" y="96" fill="#9ca3af" font-size="12" text-anchor="middle">热函数 & 稳定类型 → 标记优化</text>
        </g>

        <!-- TurboFan box -->
        <g>
          <rect x="420" y="32" width="300" height="144" rx="14" fill="url(#g1)" stroke="#0b5f86" stroke-width="1.4"/>
          <text x="570" y="64" fill="#05334a" font-size="18" font-weight="700" text-anchor="middle">TurboFan</text>
          <text x="570" y="92" fill="#05334a" font-size="13" text-anchor="middle">优化编译器（生成机器码）</text>
          <text x="570" y="116" fill="#034659" font-size="12" text-anchor="middle">基于 type feedback 做投机性优化</text>
        </g>

        <!-- optimized path -->
        <g>
          <path d="M 720 104 L 820 104" stroke="#8ef3ff" stroke-width="2.4" fill="none" marker-end="url(#arrow)"/>
          <rect x="820" y="48" width="140" height="120" rx="12" fill="#042833" stroke="#045a6b" stroke-width="1.2"/>
          <text x="890" y="84" fill="#a9fff7" font-size="16" font-weight="600" text-anchor="middle">Optimized Code</text>
          <text x="890" y="106" fill="#cfeff2" font-size="12" text-anchor="middle">机器码（快速路径）</text>

          <!-- safepoint / checks -->
          <circle cx="760" cy="160" r="6" fill="#7dd3fc"/>
          <text x="760" y="180" fill="#9ca3af" font-size="12" text-anchor="middle">safepoints / runtime checks</text>
        </g>

        <!-- bailout arrow back to ignition -->
        <g>
          <path d="M 820 132 C 700 220, 500 260, 240 200" stroke="#ff9b7d" stroke-width="2.6" fill="none" marker-end="url(#arrow)"/>
          <text x="540" y="230" fill="#ffb99a" font-size="13" text-anchor="middle">假设失效（bailout），触发 Deoptimization</text>

          <!-- reasons box -->
          <rect x="520" y="246" width="380" height="140" rx="10" fill="#071823" stroke="#3a6b6d"/>
          <text x="700" y="270" fill="#ffd8c4" font-size="13" font-weight="700" text-anchor="middle">常见触发原因</text>
          <text x="590" y="300" fill="#f2e7df" font-size="12">• 类型突变（not a Smi / double / string）</text>
          <text x="590" y="322" fill="#f2e7df" font-size="12">• 隐藏类 / map 变化（wrong map）</text>
          <text x="590" y="344" fill="#f2e7df" font-size="12">• 调用目标变化（wrong call target）</text>
          <text x="590" y="366" fill="#f2e7df" font-size="12">• 动态特性（eval / with / arguments）</text>
        </g>

        <!-- small notes near edges -->
        <text x="110" y="190" fill="#9ca3af" font-size="12" text-anchor="middle">bytecode state maintained</text>
        <text x="900" y="190" fill="#9ca3af" font-size="12" text-anchor="end">fast path / speculative assumptions</text>

        <!-- animated pulse on optimized code to show 'hot' execution -->
        <g>
          <rect id="pulse" x="820" y="48" width="140" height="120" rx="12" fill="none" stroke="#8ef3ff" stroke-width="0.8" opacity="0.0">
            <animate attributeName="opacity" values="0.0;0.22;0.0" dur="2.4s" repeatCount="indefinite"/>
            <animate attributeName="stroke-width" values="0.8;6;0.8" dur="2.4s" repeatCount="indefinite"/>
          </rect>
        </g>

      </svg>
    </div>

    <div class="legend">
      <div class="chip">Ignition = 解释执行</div>
      <div class="chip">TurboFan = 优化编译器（投机性）</div>
      <div class="chip">SafePoints / Checks</div>
      <div class="chip">Bailout = 运行时假设失败</div>
      <div class="chip">Deopt = 回退到解释器</div>
    </div>

    <p class="note">说明：图中箭头与文字为高层抽象，V8 内部还有更多状态与标志（例如：markedForOptimization、optimizedByTurboFan、deopt metadata 等）。</p>
  </div>
</body>
</html>
